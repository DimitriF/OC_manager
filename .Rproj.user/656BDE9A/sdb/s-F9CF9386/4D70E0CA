{
    "collab_server" : "",
    "contents" : "## server_visu for OC_manager\n# may be better in config.R ???\n#angle = 0.25\nVisu_roi = \"0.27,0.2,0.6,0.6\"\n\n##\nLED_pin = c(\"Red\" = 44,\"Green\"=66,\"Blue\"=64,\"254nm\"=59,\"dummy (bug to solve, always on)\"=-1)\n\noutput$Visu_control_1 = renderUI({\n  \n  tabsetPanel(\n    tabPanel(\"Capture\",\n             column(3,\n                    textInput(\"Visu_name\",\"Name of the folder\",\"sandbox\"),\n                    uiOutput(\"Visu_control_action\"),\n                    checkboxGroupInput(\"Visu_RGB_254_LED\",\"LED to turn on\",choices = LED_pin,selected=LED_pin[5]),\n                    checkboxInput(\"Visu_awb_off\",\"Turn off automatic white balance\",FALSE),\n                    verbatimTextOutput(\"Visu_feedback\"),\n                    column(6,\n                           checkboxGroupInput(\"Visu_exp\",\"Exposure choice\",c(\"auto\",50,100,200,400,800),selected = 100)\n                           ),\n                    column(6,\n                           checkboxGroupInput(\"Visu_ISO\",\"ISO choice\",c(\"auto\",100,200,400,800),selected = c(100))\n                           ),\n                    textInput(\"Visu_roi\",\"ROI to input in raspistill\",Visu_roi),\n                    actionButton(\"Visu_christmas\",\"Christmas\")\n             ),\n             column(9,\n                    # verbatimTextOutput(\"Visu_dir\"),\n                    column(6,\n                           uiOutput(\"Visu_control_dir_1\"),\n                           uiOutput(\"Visu_control_pict_1\"),\n                           uiOutput(\"Visu_control_img_1\")\n                           # plotOutput(\"Visu_control_img_1\",click = \"click_Visu_control_img_1\",height=\"400px\",width=\"400px\"),\n                           # plotOutput(\"Visu_control_chrom_1\",height=\"400px\",width=\"400px\")\n                    ),\n                    column(6,\n                           uiOutput(\"Visu_control_dir_2\"),\n                           uiOutput(\"Visu_control_pict_2\"),\n                           uiOutput(\"Visu_control_img_2\")\n                           # plotOutput(\"Visu_control_img_2\",click = \"click_Visu_control_img_2\",height=\"400px\",width=\"400px\"),\n                           # plotOutput(\"Visu_control_chrom_2\",height=\"400px\",width=\"400px\")\n                    )\n                    \n             )\n    )\n  )\n})\nVisu_feedback = reactiveValues(text=\"No feedback yet\")\nVisu_Dir = reactiveValues(dir=dir(\"www/pictures/\"))\noutput$Visu_feedback = renderPrint({\n  Visu_feedback$text\n})\noutput$Visu_dir = renderPrint({\n  Visu_Dir$dir\n})\noutput$Visu_control_dir_1 = renderUI({\n  selectizeInput(\"Visu_control_dir_1\",\"Folder to explore\",Visu_Dir$dir,selected = NULL)\n})\noutput$Visu_control_dir_2 = renderUI({\n  selectizeInput(\"Visu_control_dir_2\",\"Folder to explore\",Visu_Dir$dir,selected = NULL)\n})\noutput$Visu_control_pict_1 = renderUI({\n  selectizeInput(\"Visu_control_pict_1\",\"Picture to explore\",dir(paste0(\"www/pictures/\",input$Visu_control_dir_1),full.names = T),selected = NULL,width = \"400px\")\n})\noutput$Visu_control_pict_2 = renderUI({\n  selectizeInput(\"Visu_control_pict_2\",\"Picture to explore\",dir(paste0(\"www/pictures/\",input$Visu_control_dir_2),full.names = T),selected = NULL,width = \"400px\")\n})\nVisu_data_1 = reactive({\n  f.read.image(input$Visu_control_pict_1,height = 1000)\n})\noutput$Visu_control_img_1 = renderUI({\n  validate(need(!is.null(input$Visu_control_dir_1),\"select a folder to explore\"))\n  # par(mar=c(0,0,0,0))\n  # raster(Visu_data_1())\n  tags$img(src=gsub(pattern = \"www/\",replacement = \"\",x=input$Visu_control_pict_1),height=\"300px\",width=\"300px\")\n})\noutput$Visu_control_chrom_1 = renderPlot({\n  chrom.pict(Visu_data_1(),x=input$click_Visu_control_img_1$x,edge=10)\n})\nVisu_data_2 = reactive({\n  f.read.image(input$Visu_control_pict_2,height = 1000)\n})\noutput$Visu_control_img_2 = renderUI({\n  validate(need(!is.null(input$Visu_control_dir_2),\"select a folder to explore\"))\n  # par(mar=c(0,0,0,0))\n  # raster(Visu_data_2())\n  tags$img(src=gsub(pattern = \"www/\",replacement = \"\",x=input$Visu_control_pict_2),height=\"300px\",width=\"300px\")\n})\noutput$Visu_control_chrom_2 = renderPlot({\n  chrom.pict(Visu_data_2(),x=input$click_Visu_control_img_2$x,edge=10)\n})\n\noutput$Visu_control_action = renderUI({\n  validate(\n    need(connect$login,\"Please login\")\n  )\n  tagList(\n    actionButton(\"Visu_action\",\"take picture\"),\n    # actionButton(\"Visu_delete_repo\",\"Delete directory\"),\n    actionButton(\"Visu_position\",\"Go in position (X130 Y20), home first\")\n  )\n})\n\nobserveEvent(input$Visu_action,{\n  # if(input$Visu_name %in% dir(\"www/pictures/\")){\n  #   Visu_feedback$text = \"Change the name, directory already exist\"\n  # }else{\n    withProgress(message = \"Processing\", value=0,min=0,max=length(input$Visu_ISO)*length(input$Visu_exp)+1, {\n      dir.create(paste0(\"www/pictures/\",input$Visu_name))\n      incProgress(1,message=\"Directory created\")\n      for(ISO in input$Visu_ISO){\n        for(exp in input$Visu_exp){\n          Visu_file = paste0(\"www/pictures/\",input$Visu_name,\"/\",exp,\"ms_iso_\",ISO,\".jpg\")\n          command = paste0(\"raspistill \",\" -n \",\" -roi \",input$Visu_roi,\" -w 2000 -h 2000\")\n          if(ISO != \"auto\"){\n            command = paste0(command,\"  -ISO \",ISO)\n          }\n          if(exp != \"auto\"){\n            command = paste0(command,\" -ss \",exp,\"000\")\n          }\n          if(input$Visu_awb_off){\n            Visu_file = paste0(\"www/pictures/\",input$Visu_name,\"/\",exp,\"ms_iso_\",ISO,\"_awb_off.jpg\")\n            command = paste0(command,\" -awb off\")\n          }\n          command = paste0(command,\" -o \",Visu_file)\n          system(command)\n          #print(command)\n          incProgress(1,message=command)\n        }\n      }\n    })\n    Visu_feedback$text = \"Everything looks good, pictures created\"\n    Visu_Dir$dir = dir(\"www/pictures/\")\n    updateSelectizeInput(session,inputId = \"Visu_control_dir_1\",selected = input$Visu_name)\n  # }\n})\nobserveEvent(input$Visu_position,{\n  if(connect$board){\n    python.call(\"send_cmd\",\"G1 X130 Y20\")\n  }\n})\nobserveEvent(input$Visu_RGB_254_LED,{\n  if(connect$board){\n    for(i in LED_pin[1:3]){\n      if(i %in% input$Visu_RGB_254_LED){\n        python.call(\"send_cmd\",paste0(\"M42 P\",i,\" S255\"))\n      }else{\n        python.call(\"send_cmd\",paste0(\"M42 P\",i,\" S0\"))\n      }\n    }\n    if(LED_pin[4] %in% input$Visu_RGB_254_LED){\n      python.call(\"send_cmd\",paste0(\"M42 P\",LED_pin[4],\" S0\"))\n    }else{\n      python.call(\"send_cmd\",paste0(\"M42 P\",LED_pin[4],\" S255\"))\n    }\n  }\n})\n\nobserveEvent(input$Visu_christmas,{\n  if(connect$board){\n    for(i in sample(1:6,50,T)){\n      if(i %in% seq(3)){\n        python.call(\"send_cmd\",paste0(\"M42 P\",LED_pin[i],\" S255\"))\n        Sys.sleep(0.5)\n        python.call(\"send_cmd\",paste0(\"M42 P\",LED_pin[i],\" S0\"))\n      }else if(i == 7){\n        for(j in LED_pin[1:3]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S255\"))\n        }\n        Sys.sleep(0.5)\n        for(j in LED_pin[1:3]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S0\"))\n        }\n      }else if(i == 4){\n        for(j in LED_pin[1:2]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S255\"))\n        }\n        Sys.sleep(0.5)\n        for(j in LED_pin[1:2]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S0\"))\n        }\n      }else if(i == 5){\n        for(j in LED_pin[3:2]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S255\"))\n        }\n        Sys.sleep(0.5)\n        for(j in LED_pin[3:2]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S0\"))\n        }\n      }else if(i == 6){\n        for(j in LED_pin[c(1,3)]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S255\"))\n        }\n        Sys.sleep(0.5)\n        for(j in LED_pin[c(1,3)]){\n          python.call(\"send_cmd\",paste0(\"M42 P\",j,\" S0\"))\n        }\n      }\n    }\n  }\n  \n})",
    "created" : 1504943725369.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2318354225",
    "id" : "4D70E0CA",
    "lastKnownWriteTime" : 1505122259,
    "last_content_update" : 1505122259023,
    "path" : "~/MEGA/OC/Software/OC_manager/server_visu.R",
    "project_path" : "server_visu.R",
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}